"""
tests.test_exploitdb
~~~~~~~~~~~~~~~~~~~~~
Tests for ExploitDB CSV parsing and CVE matching.
"""

from __future__ import annotations

import pytest

from threattracer.core.exploitdb import ExploitDBClient


MOCK_CSV = """id,file,description,date_published,author,type,platform,port,date_added,date_updated,verified,codes,tags,aliases,screenshot_url,application_url,source_url
44228,exploits/java/remote/44228.py,Apache Log4j RCE (CVE-2021-44228),2021-12-12,unknown,remote,java,0,2021-12-12,2021-12-13,1,CVE-2021-44228,,,,
12345,exploits/php/webapps/12345.php,Some PHP vulnerability,2020-01-01,anon,webapps,php,80,2020-01-01,2020-01-01,0,CVE-2020-0001,,,,
"""


def test_parse_csv():
    index = ExploitDBClient._parse_csv(MOCK_CSV)
    assert "44228" in index
    assert "CVE-2021-44228" in index["44228"]["codes"]


@pytest.mark.asyncio
async def test_search_by_cve_hit():
    from unittest.mock import AsyncMock, MagicMock
    from threattracer.utils.config import AppConfig

    config = AppConfig()
    mock_http = MagicMock()
    mock_cache = MagicMock()
    mock_cache.get = AsyncMock(return_value=None)
    mock_cache.set = AsyncMock()
    mock_http.get_text = AsyncMock(return_value=MOCK_CSV)

    client = ExploitDBClient(config, mock_http, mock_cache)
    results = await client.search_by_cve("CVE-2021-44228")

    assert len(results) >= 1
    assert any("44228" in r.link for r in results)


@pytest.mark.asyncio
async def test_search_by_cve_miss():
    from unittest.mock import AsyncMock, MagicMock
    from threattracer.utils.config import AppConfig

    config = AppConfig()
    mock_http = MagicMock()
    mock_cache = MagicMock()
    mock_cache.get = AsyncMock(return_value=None)
    mock_cache.set = AsyncMock()
    mock_http.get_text = AsyncMock(return_value=MOCK_CSV)

    client = ExploitDBClient(config, mock_http, mock_cache)
    results = await client.search_by_cve("CVE-9999-9999")
    assert results == []


def test_row_to_entry():
    row = {
        "description": "Apache Log4j RCE",
        "type": "remote",
        "platform": "java",
    }
    entry = ExploitDBClient._row_to_entry("44228", row)
    assert entry.id == "44228"
    assert entry.exploit_type == "remote"
    assert "exploit-db.com/exploits/44228" in entry.link
